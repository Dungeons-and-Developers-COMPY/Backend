<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Question Browser</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    input, textarea { width: 100%; margin-bottom: 0.5rem; padding: 0.5rem; }
    button { padding: 0.5rem 1rem; margin-right: 0.5rem; cursor: pointer; }
    .filter-btn.active {
      background: #007bff;
      color: #fff;
    }
    #filters { margin: 1.5rem 0; }
    .question-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .question-list button {
      text-align: left;
      background: #f8f8f8;
      border: 1px solid #ccc;
      padding: 0.75rem;
      font-size: 1rem;
    }
    .question-detail { margin-top: 1.5rem; }
    .navigation, .back-button {
      margin-top: 1.5rem;
    }
    .navigation button, .back-button button {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>Add a New Question</h1>
  <form id="question-form">
    <input name="title" placeholder="Title" required />
    <textarea name="prompt" placeholder="Prompt Markdown" rows="4" required></textarea>
    <input name="difficulty" placeholder="Difficulty (easy, medium, hard)" required />
    <input name="question_number" placeholder="Question Number" required />
    <input name="tags" placeholder="Tags (comma-separated)" />
    <textarea name="test_cases" placeholder='Test Cases (JSON format)' rows="4"></textarea>
    <button type="submit">Save Question</button>
  </form>

  <h2>Questions</h2>

  <div id="filters">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="easy">Easy</button>
    <button class="filter-btn" data-filter="medium">Medium</button>
    <button class="filter-btn" data-filter="hard">Hard</button>
  </div>

  <!-- List View -->
  <div id="question-list" class="question-list"></div>

  <!-- Detail View -->
  <div id="question-detail" class="question-detail" style="display:none;"></div>

  <!-- Back Button -->
  <div class="back-button" style="display:none;">
    <button onclick="goBackToList()">← Back to Questions</button>
  </div>

  <!-- Navigation Arrows -->
  <div class="navigation" style="display:none;">
    <button id="prev-btn">← Previous</button>
    <button id="next-btn">Next →</button>
  </div>

  <script>
    const form = document.getElementById('question-form');
    const listContainer = document.getElementById('question-list');
    const detailContainer = document.getElementById('question-detail');
    const backContainer = document.querySelector('.back-button');
    const navigation = document.querySelector('.navigation');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const filterButtons = document.querySelectorAll('.filter-btn');

    let allQuestions = [];
    let filteredQuestions = [];
    let currentFilter = 'all';
    let currentIndex = 0;
    let editMode = false;
    let editingId = null;

    // Filter Buttons
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        currentFilter = btn.dataset.filter;
        currentIndex = 0;
        setActiveButton(btn);
        renderListView();
        hideDetailView();
      });
    });

    function setActiveButton(activeBtn) {
      filterButtons.forEach(b => b.classList.toggle('active', b === activeBtn));
    }

    // Load from backend
    function loadQuestions() {
      fetch('/questions/')
        .then(res => res.json())
        .then(questions => {
          allQuestions = questions;
          renderListView();
        })
        .catch(() => {
          listContainer.innerHTML = '<p>Failed to load questions.</p>';
        });
    }

    // Filter and render list of titles
    function renderListView() {
      listContainer.innerHTML = '';
      filteredQuestions = allQuestions.filter(q =>
        currentFilter === 'all' || (q.difficulty || '').toLowerCase() === currentFilter
      );

      if (filteredQuestions.length === 0) {
        listContainer.innerHTML = '<p>No questions match this filter.</p>';
        return;
      }

      filteredQuestions.forEach((q, i) => {
        const btn = document.createElement('button');
        btn.textContent = `Q${q.question_number}: ${q.title}`;
        btn.onclick = () => showDetailView(i);
        listContainer.appendChild(btn);
      });
    }

    // Show a single question
    function showDetailView(index) {
      currentIndex = index;
      const q = filteredQuestions[currentIndex];
      detailContainer.innerHTML = `
        <h3>Q${q.question_number}: ${q.title}</h3>
        <pre>${q.prompt_md}</pre>
        <p><strong>Difficulty:</strong> ${q.difficulty}</p>
        <p><strong>Tags:</strong> ${q.tags}</p>
        <p><strong>Test Cases:</strong><pre>${q.test_cases}</pre></p>
        <button onclick='editQuestion(${q.id}, ${JSON.stringify(q.title)}, ${JSON.stringify(q.prompt_md)}, ${JSON.stringify(q.difficulty)}, ${JSON.stringify(q.tags)}, ${JSON.stringify(q.question_number)}, ${JSON.stringify(q.test_cases)})'>Edit</button>
        <button onclick="deleteQuestion(${q.id})">Delete</button>
      `;
      listContainer.style.display = 'none';
      detailContainer.style.display = 'block';
      backContainer.style.display = 'block';
      navigation.style.display = 'flex';
    }

    function hideDetailView() {
      detailContainer.style.display = 'none';
      backContainer.style.display = 'none';
      navigation.style.display = 'none';
      listContainer.style.display = 'flex';
    }

    function goBackToList() {
      hideDetailView();
    }

    // Navigation
    prevBtn.onclick = () => {
      if (currentIndex > 0) {
        showDetailView(currentIndex - 1);
      }
    };

    nextBtn.onclick = () => {
      if (currentIndex < filteredQuestions.length - 1) {
        showDetailView(currentIndex + 1);
      }
    };

    // Delete
    function deleteQuestion(id) {
      if (!confirm('Are you sure you want to delete this question?')) return;

      fetch(`/questions/${id}`, { method: 'DELETE' })
        .then(res => {
          if (!res.ok) throw new Error('Delete failed');
          return res.json();
        })
        .then(() => {
          alert('Question deleted');
          hideDetailView();
          loadQuestions();
        })
        .catch(() => alert('Failed to delete question'));
    }

    // Edit
    function editQuestion(id, title, prompt, difficulty, tags, question_number, test_cases) {
      form.title.value = title;
      form.prompt.value = prompt;
      form.difficulty.value = difficulty;
      form.tags.value = tags;
      form.question_number.value = question_number;
      form.test_cases.value = test_cases;

      editMode = true;
      editingId = id;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Form submit
    form.addEventListener('submit', e => {
      e.preventDefault();

      const data = {
        title: form.title.value,
        prompt: form.prompt.value,
        difficulty: form.difficulty.value,
        question_number: form.question_number.value,
        tags: form.tags.value,
        test_cases: form.test_cases.value
      };

      const url = editMode ? `/questions/${editingId}` : '/questions/';
      const method = editMode ? 'PUT' : 'POST';

      fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => {
          if (!res.ok) throw new Error('Save failed');
          return res.json();
        })
        .then(() => {
          alert(editMode ? 'Question updated!' : 'Question added!');
          form.reset();
          editMode = false;
          editingId = null;
          loadQuestions();
        })
        .catch(() => alert('Failed to save question'));
    });

    loadQuestions();
  </script>
</body>
</html>
