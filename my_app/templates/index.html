<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add & View Questions</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    input, textarea { width: 100%; margin-bottom: 0.5rem; padding: 0.5rem; }
    button { padding: 0.5rem 1rem; margin-right: 0.5rem; }
    .question { border-bottom: 1px solid #ccc; padding: 1rem 0; }
  </style>
</head>
<body>
  <h1>Add a New Question</h1>
  <form id="question-form">
    <input name="title" placeholder="Title" required />
    <textarea name="prompt" placeholder="Prompt Markdown" rows="4" required></textarea>
    <input name="difficulty" placeholder="Difficulty (easy, medium, hard)" required />
    <input name="tags" placeholder="Tags (comma-separated)" />
    <textarea name="test_cases" placeholder='Test cases JSON (e.g. [{"input":"1 2", "output":"3"}])' rows="3"></textarea>
    <button type="submit">Save Question</button>
  </form>

  <h2>All Questions</h2>
  <div id="questions-container">Loading questions...</div>

  <script>
    const form = document.getElementById('question-form');
    const container = document.getElementById('questions-container');

    let editMode = false;
    let editingId = null;

    function loadQuestions() {
      fetch('/questions/')
        .then(res => res.json())
        .then(questions => {
          container.innerHTML = '';
          if (questions.length === 0) {
            container.textContent = 'No questions yet.';
            return;
          }

          questions.forEach(q => {
            const div = document.createElement('div');
            div.className = 'question';

            const safeTitle = JSON.stringify(q.title);
            const safePrompt = JSON.stringify(q.prompt_md);
            const safeDifficulty = JSON.stringify(q.difficulty);
            const safeTags = JSON.stringify(q.tags);
            const safeTestCases = JSON.stringify(q.test_cases);

            div.innerHTML = `
              <h3>${q.title}</h3>
              <pre>${q.prompt_md}</pre>
              <p><strong>Difficulty:</strong> ${q.difficulty}</p>
              <p><strong>Tags:</strong> ${q.tags}</p>
              <p><strong>Test Cases:</strong> <pre>${q.test_cases}</pre></p>
              <button onclick='editQuestion(${q.id}, ${safeTitle}, ${safePrompt}, ${safeDifficulty}, ${safeTags}, ${safeTestCases})'>Edit</button>
              <button onclick="deleteQuestion(${q.id})">Delete</button>
              <hr/>
            `;
            container.appendChild(div);
          });
        })
        .catch(() => {
          container.textContent = 'Failed to load questions.';
        });
    }

    function deleteQuestion(id) {
      if (!confirm('Are you sure you want to delete this question?')) return;

      fetch(`/questions/${id}`, {
        method: 'DELETE'
      })
      .then(res => {
        if (!res.ok) throw new Error('Delete failed');
        return res.json();
      })
      .then(() => {
        alert('Question deleted');
        loadQuestions();
      })
      .catch(() => alert('Failed to delete question'));
    }

    function editQuestion(id, title, prompt, difficulty, tags, test_cases) {
      form.title.value = title;
      form.prompt.value = prompt;
      form.difficulty.value = difficulty;
      form.tags.value = tags;
      form.test_cases.value = test_cases;

      editMode = true;
      editingId = id;
    }

    form.addEventListener('submit', e => {
      e.preventDefault();

      const data = {
        title: form.title.value,
        prompt: form.prompt.value,
        difficulty: form.difficulty.value,
        tags: form.tags.value,
        test_cases: form.test_cases.value
      };

      const url = editMode ? `/questions/${editingId}` : '/questions/';
      const method = editMode ? 'PUT' : 'POST';

      fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => {
        if (!res.ok) throw new Error('Save failed');
        return res.json();
      })
      .then(() => {
        alert(editMode ? 'Question updated!' : 'Question added!');
        form.reset();
        editMode = false;
        editingId = null;
        loadQuestions();
      })
      .catch(() => alert('Failed to save question'));
    });

    // Initial load
    loadQuestions();
  </script>
</body>
</html>
